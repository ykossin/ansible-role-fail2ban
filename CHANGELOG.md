# Changelog роли fail2ban

## [2.1.0] - 2026-01

### Добавлено

#### Новые функции:
- ✅ **Проверка лог-файлов** (`tasks/logs-check.yml`)
  - Проверка существования лог-файлов и директорий
  - Проверка прав доступа к логам
  - Автоматическое создание директорий (опционально)
  - Предупреждения о проблемах с логами

- ✅ **Логирование действий роли** (`tasks/logging.yml`)
  - Запись действий в `/var/log/ansible-fail2ban.log`
  - Логирование установки, конфигурации, ошибок
  - Опционально (через переменную `fail2ban_log_actions`)

- ✅ **Метрики и статистика** (`tasks/metrics.yml`)
  - Сбор статистики по jail
  - Количество забаненных IP
  - Статистика по каждому jail
  - Опционально (через переменную `fail2ban_collect_metrics`)

- ✅ **Molecule тесты**
  - Полная инфраструктура тестирования
  - Тесты на Debian Bookworm, Bullseye, Ubuntu 22.04, 24.04
  - Проверка установки, конфигурации, работы сервиса
  - Проверка синтаксиса и статуса jail

- ✅ **Дополнительные jail по умолчанию**
  - Примеры для nginx, apache, postfix, dovecot, recidive
  - Все отключены по умолчанию
  - Готовы к использованию после раскомментирования

#### Новые переменные:
- `fail2ban_create_log_dirs` - автоматическое создание директорий для логов
- `fail2ban_log_actions` - включение логирования действий роли
- `fail2ban_actions_log_path` - путь к лог-файлу действий
- `fail2ban_collect_metrics` - включение сбора метрик

---

## [2.0.0] - 2026-01

### Добавлено

#### Критичные улучшения:
- ✅ **Валидация переменных** (`tasks/validation.yml`)
  - Проверка всех входных переменных перед применением
  - Валидация конфигураций jail
  - Детальные сообщения об ошибках

- ✅ **Обработка ошибок при установке** (`tasks/installation.yml`)
  - Регистрация результата установки
  - Детальные сообщения об ошибках
  - Проверка зависимостей (ufw, iptables)

- ✅ **Автоматический бэкап конфигурации** (`tasks/backup.yml`)
  - Создание бэкапов перед изменениями
  - Хранение последних 5 бэкапов
  - Автоматическая очистка старых бэкапов

- ✅ **Проверка синтаксиса конфигурации** (`tasks/check.yml`)
  - Валидация конфигурации через `fail2ban-client -t`
  - Проверка перед перезапуском сервиса

#### Новые настройки:
- ✅ **Backend настройка** - поддержка systemd, pyinotify, auto
- ✅ **Rate limiting** - ограничение частоты действий
- ✅ **IPv6 поддержка** - настройка поддержки IPv6
- ✅ **Chain для iptables** - настройка цепочки iptables

#### Модульная структура:
- ✅ Разделение задач на логические модули:
  - `validation.yml` - валидация переменных
  - `installation.yml` - установка и проверка зависимостей
  - `backup.yml` - создание бэкапов
  - `config.yml` - настройка конфигурации
  - `service.yml` - управление сервисом
  - `check.yml` - проверка статуса и синтаксиса

### Изменено

- ✅ Реорганизован `tasks/main.yml` - теперь использует модульную структуру
- ✅ Обновлен `defaults/main.yml` - добавлены новые настройки
- ✅ Обновлен шаблон `jail.local.j2` - поддержка новых настроек
- ✅ Обновлен `README.md` - документация новых возможностей

### Улучшено

- ✅ Обработка ошибок при проверке jail
- ✅ Сообщения об ошибках стали более информативными
- ✅ Проверка зависимостей перед использованием
- ✅ Документация и примеры использования

### Безопасность

- ✅ Валидация всех входных данных
- ✅ Автоматический бэкап перед изменениями
- ✅ Проверка синтаксиса перед применением
- ✅ Проверка наличия необходимых зависимостей

---

## [1.0.0] - Предыдущая версия

Базовая функциональность:
- Установка fail2ban
- Настройка jail
- Базовые настройки конфигурации
- Email уведомления
