---
# Основные задачи для настройки fail2ban

- name: Установка fail2ban
  apt:
    name: fail2ban
    state: present
    update_cache: true
  when: fail2ban_enabled
  tags:
    - fail2ban
    - packages

- name: Остановка fail2ban перед настройкой
  systemd:
    name: fail2ban
    state: stopped
  when:
    - fail2ban_enabled
  tags:
    - fail2ban
    - service

- name: Создание конфигурации jail.local
  template:
    src: jail.local.j2
    dest: /etc/fail2ban/jail.local
    owner: root
    group: root
    mode: '0644'
  notify: restart fail2ban
  when: fail2ban_enabled
  tags:
    - fail2ban
    - config

- name: Создание пользовательских фильтров
  template:
    src: filter.conf.j2
    dest: "/etc/fail2ban/filter.d/{{ item.name }}.conf"
    owner: root
    group: root
    mode: '0644'
  loop: "{{ fail2ban_filters }}"
  notify: restart fail2ban
  when:
    - fail2ban_enabled
    - fail2ban_filters | length > 0
  tags:
    - fail2ban
    - filters

- name: Создание пользовательских действий
  template:
    src: action.conf.j2
    dest: "/etc/fail2ban/action.d/{{ item.name }}.conf"
    owner: root
    group: root
    mode: '0644'
  loop: "{{ fail2ban_actions }}"
  notify: restart fail2ban
  when:
    - fail2ban_enabled
    - fail2ban_actions | length > 0
  tags:
    - fail2ban
    - actions

- name: Управление состоянием fail2ban
  systemd:
    name: fail2ban
    state: "{{ fail2ban_state }}"
    enabled: "{{ fail2ban_enabled_on_boot }}"
    daemon_reload: true
  when: fail2ban_enabled
  register: fail2ban_service
  tags:
    - fail2ban
    - service

- name: Ожидание запуска fail2ban
  wait_for:
    path: /var/run/fail2ban/fail2ban.sock
    delay: 2
    timeout: 10
  when:
    - fail2ban_enabled
    - fail2ban_state == "started"
  tags:
    - fail2ban
    - service

- name: Проверка статуса fail2ban
  command: fail2ban-client status
  register: fail2ban_status
  changed_when: false
  when: fail2ban_enabled
  tags:
    - fail2ban
    - check

- name: Отображение статуса fail2ban
  debug:
    msg: "{{ fail2ban_status.stdout_lines }}"
  when:
    - fail2ban_enabled
    - fail2ban_status.stdout_lines is defined
  tags:
    - fail2ban
    - check

- name: Проверка активных jail
  command: fail2ban-client status {{ item.name }}
  register: jail_status
  loop: "{{ fail2ban_jails }}"
  when:
    - fail2ban_enabled
    - item.enabled | default(true)
    - fail2ban_state == "started"
  changed_when: false
  failed_when: false
  tags:
    - fail2ban
    - check

- name: Отображение информации о jail
  debug:
    msg:
      - "Jail: {{ item.item.name }}"
      - "{{ item.stdout_lines }}"
  loop: "{{ jail_status.results }}"
  when:
    - fail2ban_enabled
    - jail_status is defined
    - item.rc == 0
  tags:
    - fail2ban
    - check

- name: Информация о fail2ban
  debug:
    msg:
      - "fail2ban настроен и {{ fail2ban_state }}!"
      - "Активных jail: {{ fail2ban_jails | selectattr('enabled', 'equalto', true) | list | length }}"
      - "Время бана: {{ fail2ban_config.bantime }} секунд"
      - "Максимум попыток: {{ fail2ban_config.maxretry }}"
      - "Окно времени: {{ fail2ban_config.findtime }} секунд"
      - "Проверка: fail2ban-client status"
  when: fail2ban_enabled
  tags:
    - fail2ban
